<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار الاتصال بقاعدة البيانات - كرم</title>
    <link rel="stylesheet" href="styles/design-system.css">
    <link rel="stylesheet" href="styles/main.css">
    <style>
        body {
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
        }

        .status {
            padding: 10px;
            border-radius: var(--radius-md);
            margin-top: 10px;
        }

        .status.success {
            background: var(--color-success-light);
            color: var(--color-success-dark);
        }

        .status.error {
            background: var(--color-error-light);
            color: var(--color-error-dark);
        }

        .status.loading {
            background: var(--color-bg);
        }
    </style>
</head>

<body>
    <h1>اختبار الاتصال بقاعدة البيانات</h1>
    <p>هذه الصفحة تختبر الاتصال بـ Supabase</p>

    <div class="test-section">
        <h2>1. اختبار تحميل Supabase</h2>
        <div id="supabase-test" class="status loading">جاري الاختبار...</div>
    </div>

    <div class="test-section">
        <h2>2. اختبار الاتصال بقاعدة البيانات</h2>
        <div id="database-test" class="status loading">جاري الاختبار...</div>
    </div>

    <div class="test-section">
        <h2>3. اختبار جلب الأسر</h2>
        <button onclick="testFetchFamilies()" class="btn btn-primary">جلب الأسر</button>
        <div id="families-test" class="status loading" style="margin-top: 10px;">اضغط الزر للاختبار</div>
        <pre id="families-data"
            style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; max-height: 300px; overflow: auto;"></pre>
    </div>

    <div class="test-section">
        <h2>4. اختبار التسجيل (Demo)</h2>
        <button onclick="testSignup()" class="btn btn-secondary">تسجيل مستخدم تجريبي</button>
        <div id="signup-test" class="status loading" style="margin-top: 10px;">اضغط الزر للاختبار</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // تحقق من المفاتيح
        const SUPABASE_URL = 'https://kjypovbotpmeblotwzsu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtqeXBvdmJvdHBtZWJsb3R3enN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwOTY5ODEsImV4cCI6MjA4MDY3Mjk4MX0.Jzc_Pd25WCxrWipakJ5T3UMWruUwj6-UEaFfUk27XaY';

        let supabase;

        // Test 1: تحميل Supabase
        try {
            const { createClient } = window.supabase;
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            if (SUPABASE_URL === 'https://your-project.supabase.co') {
                document.getElementById('supabase-test').className = 'status error';
                document.getElementById('supabase-test').innerHTML = '❌ لم يتم تحديث مفاتيح Supabase!<br>افتح test-database.html وحدّث SUPABASE_URL و SUPABASE_ANON_KEY';
            } else {
                document.getElementById('supabase-test').className = 'status success';
                document.getElementById('supabase-test').textContent = '✓ تم تحميل Supabase بنجاح';
            }
        } catch (error) {
            document.getElementById('supabase-test').className = 'status error';
            document.getElementById('supabase-test').textContent = '❌ فشل تحميل Supabase: ' + error.message;
        }

        // Test 2: الاتصال بقاعدة البيانات
        async function testDatabaseConnection() {
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('count');

                if (error) throw error;

                document.getElementById('database-test').className = 'status success';
                document.getElementById('database-test').textContent = '✓ الاتصال بقاعدة البيانات ناجح';
            } catch (error) {
                document.getElementById('database-test').className = 'status error';
                document.getElementById('database-test').innerHTML = `❌ فشل الاتصال: ${error.message}<br>الرجاء التأكد من:<br>1. تنفيذ complete_schema.sql<br>2. المفاتيح صحيحة`;
            }
        }

        // Test 3: جلب الأسر
        async function testFetchFamilies() {
            document.getElementById('families-test').className = 'status loading';
            document.getElementById('families-test').textContent = 'جاري جلب البيانات...';

            try {
                const { data, error } = await supabase
                    .from('host_families')
                    .select('*')
                    .limit(5);

                if (error) throw error;

                document.getElementById('families-test').className = 'status success';
                document.getElementById('families-test').textContent = `✓ تم جلب ${data.length} أسرة من قاعدة البيانات`;
                document.getElementById('families-data').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('families-test').className = 'status error';
                document.getElementById('families-test').innerHTML = `❌ فشل جلب البيانات: ${error.message}<br>تأكد من:<br>1. تنفيذ السكريبت SQL<br>2. وجود بيانات في جدول host_families`;
                document.getElementById('families-data').textContent = '';
            }
        }

        // Test 4: تسجيل مستخدم
        async function testSignup() {
            document.getElementById('signup-test').className = 'status loading';
            document.getElementById('signup-test').textContent = 'جاري التسجيل...';

            const testEmail = `test${Date.now()}@test.com`;
            const testPassword = 'Test@123456';

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: testEmail,
                    password: testPassword,
                    options: {
                        data: {
                            full_name: 'مستخدم تجريبي'
                        }
                    }
                });

                if (error) throw error;

                document.getElementById('signup-test').className = 'status success';
                document.getElementById('signup-test').innerHTML = `✓ تم التسجيل بنجاح!<br>البريد: ${testEmail}<br>تحقق من بريدك لتأكيد الحساب`;
            } catch (error) {
                document.getElementById('signup-test').className = 'status error';
                document.getElementById('signup-test').innerHTML = `❌ فشل التسجيل: ${error.message}`;
            }
        }

        // تشغيل الاختبارات التلقائية
        if (SUPABASE_URL !== 'https://your-project.supabase.co') {
            testDatabaseConnection();
        }
    </script>
</body>

</html>